# Django - ëŒ“ê¸€, íšŒì› ì •ë³´ ë³€ê²½

*2019.04.16*

## 1. Comment(ëŒ“ê¸€)

comment ìƒì„±ê³¼ ì‚­ì œëŠ” ì•„ë˜ urlë¡œ ì •ì˜í•œë‹¤.

```python
app_name = 'posts'
urlpatterns = [
    ...
    path('<int:post_id>/comment/create/', views.create_comment, name='create_comment'),
    path('<int:comment_id>/comment/delete/', views.delete_comment, name='delete_comment'),
]
```



### 1-1. Comment ëª¨ë¸ ì •ì˜

Comment í…Œì´ë¸”ì€ ë‘ê°œì˜ ì™¸ë˜í‚¤(User, Post)ë¥¼ ê°–ë„ë¡ í•´ì•¼ ê²Œì‹œê¸€ê³¼ ëŒ“ê¸€ìœ ì €ê°€ ë§¤í•‘ëœë‹¤.

```python
# posts/models.py
class Comment(models.Model) :
    # comment user
    user = models.ForeignKey(settings.AUTH_USER_MODEL,on_delete=models.CASCADE)
    # comment post
    post = models.ForeignKey(Post,on_delete=models.CASCADE)
    content = models.CharField(max_length=150)
```



### 1-2. CommentModelForm ì •ì˜ ë° ì‚¬ìš©

```python
# posts/forms.py
class CommentModelForm(forms.ModelForm):
    class Meta :
        model = Comment
        fields = ['content']
```

```python
# posts/views.py
def list(request) :
    posts = Post.objects.all()
    # commentë¥¼ ì¶œë ¥ ë° ìƒì„±í•˜ëŠ” ê³³ì€ list!
    commentForm = CommentModelForm()
    return render(request,'posts/list.html', {'posts' : posts, 'commentForm':commentForm})
```

```html
<!-- list.html -->
...
<div class='card-body'>
    <!-- commentì— ëŒ€í•œ ëª¨ë¸í¼ -->
    <form method='POST' action="{% url 'posts:create_comment' post.id %}">
        {% csrf_token %}
        <!-- bootstrap form -->
        {% bootstrap_form commentForm %}
        <button type='submit' class='btn btn-info'>ëŒ“ê¸€ì“°ê¸°</button>
    </form>
    <!-- í•´ë‹¹ ê²Œì‹œê¸€ì˜ ëª¨ë“  ëŒ“ê¸€ì„ ì¶œë ¥ -->
    <br>
    {% for comment in post.comment_set.all %}
    <hr>
    <p class="card-text">{{ comment.content }}
        <!-- comment ì‘ì„±ìê°€ ë™ì¼í•˜ë‹¤ë©´, ì‚­ì œë²„íŠ¼ ì¶œë ¥ -->
        {% if comment.user == request.user %}
        <a href="{% url 'posts:delete_comment' comment.id %}" class='btn btn-danger'>ì‚­ì œ</a>
        {% endif %}
    </p>
    {% empty %}
    <p>ë“±ë¡ëœ ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</p>
    {% endfor %}
</div>
```

>  #### forë¬¸: {% empty %}
>  ë¹„ì–´ìˆë‹¤ë©´, empty ì´í›„ì˜ ë‚´ìš©ì„ ì¶œë ¥í•œë‹¤.



### 1-3. Comment ìƒì„± í•¨ìˆ˜

```python
@login_required
@require_POST
def create_comment(request, post_id):
    form = CommentModelForm(request.POST)
    if form.is_valid() :
        comment = form.save(commit=False)
        comment.post_id = post_id
        comment.user = request.user
        comment.save()
    
    return redirect('posts:list')
```

>  #### @require_POST
>  postìš”ì²­ë§Œ ì²˜ë¦¬ë˜ë„ë¡ í•˜ëŠ” í´ë˜ìŠ¤ ë©”ì„œë“œ
>  from django.views.decorators.http import require_POST



### 1-4. Comment ì‚­ì œ í•¨ìˆ˜

```python
def delete_comment(request, comment_id) :
    comment = get_object_or_404(Comment, pk=comment_id)
    comment.delete()
    
    return redirect('posts:list')
```



## 2. íšŒì›ì •ë³´ë³€ê²½ ğŸ¤Ÿ

followê¸°ëŠ¥ì„ ë§Œë“¤ê¸° ìœ„í•´ì„œëŠ” Djangoì˜ Authì˜ Userëª¨ë¸ì„ ìˆ˜ì •í•´ì•¼ í•œë‹¤.
[Django - Auth/models.py](https://github.com/django/django/blob/master/django/contrib/auth/models.py)



### 1-1. UserChangeForm 

UserChangeFormì„ ì´ìš©í•œ Djangoì˜ Userì •ë³´ë¥¼ ë³€ê²½í•œë‹¤.

```python
# accounts/views.py
from django.contrib.auth.forms import UserChangeForm
```

UserChangeFormì„ ë°”ë¡œ ì‚¬ìš©í•  ê²½ìš°ì˜ ë¬¸ì œì ì€ ì‚¬ìš©ìë¡œ ë¶€í„° ì…ë ¥ ë°›ê³  ì‹¶ì§€ ì•Šì€ ì •ë³´ë„ form í˜•ì‹ìœ¼ë¡œ ë³´ì—¬ì£¼ê²Œ ëœë‹¤. [1-2]ì—ì„œ ìˆ˜ì •í•´ì„œ ì‚¬ìš©í•¨

*1-3ì—ì„œ CustomUserChangeFormìœ¼ë¡œ ìƒì†ë°›ì•„ ì‚¬ìš©í–ˆìœ¼ë¯€ë¡œ ìµœì¢… ì½”ë“œì—ì„  UserChangeForm ì´ ì§ì ‘ì ìœ¼ë¡œ ì‚¬ìš©ë˜ì§„ ì•ŠìŒ*



### 1-2. [íšŒì›ì •ë³´ìˆ˜ì •] UserChangeForm ìƒì†, Form ì¬ì •ì˜

django.contrib.auth.modelsë¡œë¶€í„° Userëª¨ë¸ì„ importí•´ì„œ ì‚¬ìš©í•˜ëŠ” ê²ƒë„ ë¬¼ë¡  ê°€ëŠ¥í•˜ë‹¤. ê·¸ëŸ¬ë‚˜ ì¶”í›„  Userëª¨ë¸ì„ ì»¤ìŠ¤í…€í•˜ì—¬ ì‚¬ìš©í•˜ëŠ” ê²½ìš°, ë¬¸ì œê°€ ìƒê¸´ë‹¤. ë•Œë¬¸ì— **get_user_model()**ì„ ì‚¬ìš©í•´ì•¼í•œë‹¤.

```python
# accounts/forms.py
from django.contrib.auth.forms import UserChangeForm
from django.contrib.auth import get_user_model

# UserChangeFormì„ ìƒì†ë°›ì•„ì„œ ì¬ì •ì˜
class CustomUserChangeForm(UserChangeForm) :
    class Meta :
        model = get_user_model()
        fields = ['username','email','last_name','first_name']
```


```python
from .forms import CustomUserChangeForm

def update(request) :
    if request.method == 'POST' :
        user_change_form = CustomUserChangeForm(request.POST, instance=request.user)
        if user_change_form.is_valid() :
            # ê°ì²´ê°€ ì €ì¥ë˜ê³  ë‚œ í›„ì˜ ê°’ì„ ë°˜í™˜í•œë‹¤.
           user = user_change_form.save()
           return redirect('people', user.name)
        
    else :
        # ë³€ê²½ë  ì‚¬ìš©ìì˜ ì •ë³´ë¥¼ ê°™ì´ ë„˜ê²¨ì¤˜ì•¼ í•œë‹¤.
        user_change_form = CustomUserChangeForm(instance=request.user)
        # passwd_change_form = PasswordChangeForm(request.user)
        context={
            'user_change_form' : user_change_form,
            
        }
        return render(request,'accounts/update.html',context)
```

```html
<!-- accounts/update.html -->
{% extends 'base.html' %}
{% load bootstrap4 %}
{% block body %}
<h1 class='text-center'>íšŒì›ì •ë³´</h1>
<form method='POST'>
  {% csrf_token %}
  <!-- ëª¨ë¸ í¼ -->
  {% bootstrap_form user_change_form %}

  <button type='submit' class='btn btn-primary'>ì •ë³´ìˆ˜ì •</button>
</form>
{% endblock %}
```

&#8251; ë¹„ë°€ë²ˆí˜¸ëŠ” UserChangeFormì´ ì•„ë‹ˆë¼ PasswordChangeFormì„ ë”°ë¡œ ì‚¬ìš©í•´ì•¼ í•œë‹¤.



### 1-3. [ë¹„ë°€ë²ˆí˜¸ë³€ê²½] PasswordChangeForm

> #### update_session_auth_hash í•¨ìˆ˜
>
> ë¹„ë°€ë²ˆí˜¸ë¥¼ ë³€ê²½í•˜ëŠ” ê²½ìš°, ì‚¬ìš©ì **ë¡œê·¸ì¸ì´ í’€ë¦¬ëŠ” ë¬¸ì œì ì´ ë°œìƒ**(ì‚¬ìš©ì ë¹„ë°€ë²ˆí˜¸ì˜  hashê°’ ë³€ê²½ìœ¼ë¡œ ì¸í•´)í•œë‹¤. ë•Œë¬¸ì— ì´ì „ì— ìˆë˜ ì„¸ì…˜ì„ ê·¸ëŒ€ë¡œ ì‚¬ìš©í•˜ì—¬ ë¡œê·¸ì¸ì„ ìœ ì§€í•˜ë„ë¡ í•˜ì. 
>
> [1-2]ì—ì„œ usernamì€ ë³€ê²½í•´ë„ ë¡œê·¸ì¸ì´ í’€ë¦¬ì§€ ì•ŠëŠ”ë‹¤. ê·¸ëŸ°ë° passwordë¥¼ ë³€ê²½í•˜ëŠ” ê²½ìš°, ë¡œê·¸ì¸ì´ í’€ë¦°ë‹¤. ì´ë¥¼ í†µí•´, ì‚¬ìš©ì ì„¸ì…˜ì„ ë§Œë“œëŠ” í•´ì‹œëŠ” ë¹„ë°€ë²ˆí˜¸ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ë§Œë“¤ì–´ì§ì„ ì•Œ ìˆ˜ ìˆë‹¤.
>
> [update_session_auth_hash()](https://docs.djangoproject.com/en/2.2/topics/auth/default/#django.contrib.auth.update_session_auth_hash) 

```python
from django.contrib.auth import update_session_auth_hash

def passwd(request) :
    if request.method == "POST" :
        passwd_change_form = PasswordChangeForm(request.user, request.POST)
        if passwd_change_form.is_valid() :
            passwd_change_form.save()
            # ì„¸ì…˜ ì—…ë°ì´íŠ¸ ë° ìœ ì§€
            update_session_auth_hash(request, passwd_change_form.user)
            return redirect('people', request.user.username)
    else :
       passwd_change_form = PasswordChangeForm(request.user) 
       return render(request, 'accounts/passwd.html',{'passwd_change_form' : passwd_change_form})
```

```html
<!-- accounts/delete.html -->
{% extends 'base.html' %}
{% load bootstrap4 %}
{% block body %}
<h1 class='text-center'>ë¹„ë°€ë²ˆí˜¸ë³€ê²½</h1>
<form method='POST'>
  {% csrf_token %}
  <!-- ëª¨ë¸ í¼ -->
  {% bootstrap_form passwd_change_form %}

  <button type='submit' class='btn btn-primary'>ì •ë³´ìˆ˜ì •</button>
</form>
{% endblock %}
```



#### 1-4. [íšŒì›íƒˆí‡´] 

íšŒì› íƒˆí‡´ëŠ” ë˜ëŒë¦´ ìˆ˜ ì—†ìœ¼ë¯€ë¡œ,  í™•ì¸ì°½(delete.html)ì„ ë„ì–´ ì£¼ì.

```python
def delete(request) :
    if request.method == "POST" :
        request.user.delete()
        return redirect('accounts:signup')
    return render(request,'accounts/delete.html')
```

