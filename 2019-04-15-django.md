# Django - likeê¸°ëŠ¥

*2019.04.15*

## 1. like ëª¨ë¸ë§

```python
# posts/models.py
from django.db import models
from django.conf import settings

# Create your models here.
class Post(models.Model):
    content =models.CharField(max_length=150)
    image = models.ImageField(blank=True)
    # Postì˜ ìœ ì €
    user = models.ForeignKey(settings.AUTH_USER_MODEL,on_delete=models.CASCADE)
    # í•´ë‹¹ Postì— 'ì¢‹ì•„ìš”'ë¥¼ í‘œì‹œí•œ ì‚¬ìš©ì
    like_users = models.ManyToManyField(settings.AUTH_USER_MODEL,related_name='like_posts', blank=True)
    
    def __str__(self) :
        return self.content
```

```shell
$python managy.py shell_plus
>>> post = Post.objects.first()
>>> user = User.objects.first()
# userê°€ postì— 'ì¢‹ì•„ìš”' í‘œì‹œ
>>> user.like_posts.add(post)
# í•œë²ˆì— 'ì¢‹ì•„ìš”' í‘œì‹œ
>>> user.like_posts.add(Post.objects.first())

>>> nayeong = User.objects.get(pk=1)
>>> nayeong.post_set.all()
#nayeongê°€ ì‘ì„±í•œ ì²«ë²ˆì§¸ postì¤‘ì— 'ì¢‹ì•„ìš”'ë¥¼ ëˆ„ë¥¸ ì‚¬ìš©ìë¥¼ ì¸¨ë ¥í•˜ë¼ 
>>> nayeong.post_set.first().like_users.all()
```



## 2. @login_requiredğŸ¤Ÿ

ë§Œì•½ userê°€ ì¡´ì¬í•˜ì§€ ì•Šìœ¼ë©´(ì‚¬ìš©ìê°€ ë¡œê·¸ì¸í•˜ì§€ ì•Šì€ ê²½ìš°) login í˜ì´ì§€ë¡œ redirectì‹œí‚¤ë‹¤.

@login_requiredì˜ ê²½ìš°, ì‚¬ìš©ìì— ëŒ€í•œ ë¡œê·¸ì¸ ê³„ì •ì„ accountsë¡œ ë³´ë‚¸ë‹¤. ì¦‰, ìš°ë¦¬ê°€ @login_requiredë¥¼ ì‚¬ìš©í•˜ê³  ì‹¶ë‹¤ë©´ ë¡œê·¸ì¸ í˜ì´ì§€ë¥¼ accountsë¡œ ë§Œë“¤ì.

```python
from django.contrib.auth.decorators import login_required

@login_required
def like(request, post_id):
    pass
```

[@login_required](https://docs.djangoproject.com/en/2.2/topics/auth/default/)



### 2-1. accounts êµ¬ì„±

#### 1). accounts ìƒì„± ë° ì„¤ì •

```shell
$python managy.py startapp accounts
```

(+) settings.pyì—  accounts ì¶”ê°€

#### 2). url êµ¬ì„±

```python
# urls.py
urlpatterns = [
    path('accounts/', include('accounts.urls')),...
]

# accounts/urls.py
app_name = 'accounts'
urlpatterns = [
    path('login/',views.login,name='login'),
    path('logout/',views.logout, name='logout'),
]
```



### 2-2. [ë¡œê·¸ì¸/ë¡œê·¸ì•„ì›ƒ]AuthenticationForm /  @login_requiredì˜ nextğŸ¤Ÿ

AuthenticationFormì€ djangoì—ì„œ ì œê³µí•´ì£¼ëŠ” forms ê¸°ëŠ¥ìœ¼ë¡œ ì† ì‰½ê²Œ ì‚¬ìš©ì í…Œì´ë¸” formì„ ë§Œë“¤ì–´ì¤€ë‹¤.

@login_requiredë¥¼ í†µí•´ ë¡œê·¸ì¸ìœ¼ë¡œ redirectë˜ëŠ” ê²½ìš°, ì´ì „ url(ì‚¬ìš©ìê°€ ì›í•˜ëŠ” ê¸°ëŠ¥)ì„ nextë³€ìˆ˜ì— ì €ì¥í•œë‹¤. ì¦‰, ë¡œê·¸ì¸ì„ ì²˜ë¦¬í•œ í›„ nextë³€ìˆ˜ë¡œ redirectì‹œí‚¤ë©´ ì‚¬ìš©ìê°€ ìµœì¢…ì ìœ¼ë¡œ ì›í•˜ëŠ” ì´ë²¤íŠ¸ë¥¼ ì‹¤í–‰ì‹œí‚¬ ìˆ˜ ìˆë‹¤.

```python
from django.shortcuts import render, redirect
from django.contrib.auth.forms import AuthenticationForm
from django.contrib.auth import login as auth_login
from django.contrib.auth import logout as auth_logout


# Create your views here.
def login(request) :
    if request.method == "POST":
        # POST : ì‹¤ì œ ë¡œê·¸ì¸(ì„¸ì…˜ì— ìœ ì € ì •ë³´ ì¶”ê°€)
        form = AuthenticationForm(request, request.POST)
        if form.is_valid() :
            auth_login(request, form.get_user())
            # nextê°€ ì •ì˜ë˜ì–´ ìˆë‹¤ë©´ í•´ë‹¹í•˜ëŠ” urlë¡œ redirectì‹œí‚¨ë‹¤.
            # ì¦‰, ë¡œê·¸ì¸ ì™„ë£Œ í›„, ì‚¬ìš©ìê°€ ì›í–ˆë˜ ê¸°ëŠ¥(like)ì´ ë°”ë¡œ ìˆ˜í–‰ëœë‹¤.
            return redirect(request.GET.get('next') or 'post:list')
    else:
        # GET : ë¡œê·¸ì¸ ì •ë³´ ì…ë ¤
        form = AuthenticationForm()
        return render(request, 'accounts/login.html', {'form': form}) 

def logout(request) :
    auth_logout(request)
```



### 2-3. create í•¨ìˆ˜ ë³€ê²½ğŸ¤Ÿ

1ë²ˆì—ì„œ like ëª¨ë¸ë§ìœ¼ë¡œ ì¸í•œ dbì¹¼ëŸ¼ì´ ë³€ê²½ë˜ì–´ í•´ë‹¹ postì˜ ì‚¬ìš©ì ì •ë³´ë¥¼ í•¨ê»˜ ë„˜ê²¨ì„œ postë¥¼ ìƒì„±í•´ì•¼í•œë‹¤.

```python
def create(request):
    if request.method == "POST" :
        # ì‘ì„±ëœ postë¥¼ DBì— ì ìš©
        form = PostModelForm(request.POST, request.FILES)
        if form.is_valid() :
            # ì €ì¥í•˜ëŠ” ê³¼ì •ì„ ì¼ë‹¨ ë©ˆì¶”ê³ 
            post = form.save(commit=False)
            # í˜„ì¬ ì‚¬ìš©ìì˜ userì •ë³´ë¥¼ ê°€ì ¸ì™€ì„œ Postê°ì²´ì— userë¥¼ ì €ì¥í•œ í›„, commit(save())í•˜ì!!
            post.user = request.user
            form.save()
            return redirect('posts:list')
    else :
        # postë¥¼ ì‘ì„±í•˜ëŠ” formì„ ë³´ì—¬ ì¤Œ
        form = PostModelForm()
        return render(request, 'posts/create.html', {'form': form})
```



### 2-4. íšŒì›ê°€ì…

```python
# accounts/views.py
def signup(request) :
    if request.method == "POST" :
        form = UserCreationForm(request.POST)
        if form.is_valid() :
            # ë¡œê·¸ì¸ì²˜ë¦¬ê¹Œì§€í•˜ëŠ”ë° ì´ë•Œ ë“¤ì–´ì˜¤ëŠ” passwordê°’ì€ 2ê°œê°€ ë“¤ì–´ì˜¤ë¯€ë¡œ userì—ì„œ ë°›ì•„ì˜¨ ê²°ê³¼ë¬¼ë¡œ ë¡œê·¸ì¸ ì²˜ë¦¬í•˜ì
            # auth_login(request, request.POST)
            user = form.save()
            auth_login(request, user)
            return redirect('posts:list')
    else :
        form = UserCreationForm() 
    return render(request, 'accounts/signup.html', {'form': form})
```



### 2-5. ì‚¬ìš©ì í˜ì´ì§€

**sttings.AUTH_USER_MODEL**ì€ Userì •ë³´ë¥¼ ìŠ¤íŠ¸ë§ìœ¼ë¡œ ê°€ì ¸ì˜¤ì§€ë§Œ, **get_user_model()**ì€ userê°ì²´ë¥¼ ë°˜í™˜í•œë‹¤.

```python
# accounts/views.py
from django.contrib.auth import get_user_model

def people(request,username) :
    # ì‚¬ìš©ìì— ëŒ€í•œ ì •ë³´ 
    people = get_object_or_404(get_user_model(),username=username)
    return render(request, 'accounts/people.html', {'people': poeple})
```

