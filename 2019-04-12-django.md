# Django - M:N ê´€ê³„ ëª¨ë¸ë§

*2019.04.12*

## 1. [ë°©ë²•1] M:N ê´€ê³„ ëª¨ë¸ ì§ì ‘ ì •ì˜ðŸ¤Ÿ

ëŒ€í‘œì ì¸ M:N ê´€ê³„ë¡œëŠ” ìˆ˜ê°•ì‹ ì²­, ì˜ˆì•½ ë“±ì„ ìƒê°í•´ë³¼ ìˆ˜ ìžˆë‹¤.

```python
"""
models.py
"""
class Student(models.Model) :
	name = models.CharField(max_length=30)
	student_id = models.IntegerField()
	
class Lecture(models.Model) :
	title = models.CharField(max_length=100)
    
# M:Nì˜ ê´€ê³„ë¥¼ ê°€ì§€ëŠ” ëª¨ë¸ ì •ì˜
class Enrollment(models.Model) :
	lecture  = models.ForeignKey(Lecture, on_delete =models.CASCADE)
	student  = models.ForeignKey(Student, on_delete =models.CASCADE)
```



### 1-2. dummy()í•¨ìˆ˜ : ë”ë¯¸ë°ì´í„° ìƒì„±

@classmethodë¥¼ ì‚¬ìš©í•˜ì—¬ í´ëž˜ìŠ¤ ê°ì²´ ìžì‹ ì„  clsë¡œ í˜¸ì¶œí•´ì„œ ì‚¬ìš©ì´ ê°€ëŠ¥í•˜ë‹¤.

```python
from faker import Faker
import random
fake = Faker('ko_kr')

class Student(models.Model) :
	name = models.CharField(max_length=30)
	student_id = models.IntegerField()
	
    # ë”ë¯¸ë°ì´í„° ìƒì„±í•˜ëŠ” ë¶€ë¶„
	@classmethod
	def dummy(cls,n) :
	    for i in range(n) :
	        cls.objects.create(name=fake.name(), student_id=random.randint(2000, 2020))
```



### 1-3. ë°ì´í„° ì‚½ìž… / ì¡°íšŒ

```shell
$ python managy.py shell_plus
>>> Lecture.objects.create(title='ë°ì´í„°ë² ì´ìŠ¤') 

# 2ë²ˆì—ì„œ ì •ì˜í•œ dummy()í•¨ìˆ˜ ì‚¬ìš©
>>> Student.dummy(10)

# Enrollmentì˜ ë°ì´í„° ì‚½ìž…ì€ foreginKeyë¥¼ ì‚½ìž…í•˜ëŠ” ë°©ì‹ìœ¼ë¡œ ì €ìž¥í•œë‹¤.
>>> Enrollment.objects.create(student_id=1, lecture_id=1)
# ì•„ëž˜ì˜ ì½”ë“œë¥¼ í†µí•´ Enrollmentì—ì„œ Studentì™€ Lectureì˜ ë°ì´í„°ë¥¼ ì–´ë–¤ì‹ìœ¼ë¡œ ì ‘ê·¼í•˜ëŠ”ì§€ ì•Œ ìˆ˜ ìžˆë‹¤.
>>> enroll = Enrollment.objects.first()
>>> enroll.student.name # Studentí…Œì´ë¸”ì— ì €ìž¥ëœ nameì´ ì¶œë ¥ëœë‹¤.
```

Enrollmentëª¨ë¸ì´ ì°¸ì¡°í•˜ê³  ìžˆëŠ” í…Œì´ë¸”ì— ì–´ë–¤ì‹ìœ¼ë¡œ ì ‘ê·¼í•  ìˆ˜ ìžˆëŠ” ì§€ë¥¼ ì•Œ ìˆ˜ ìžˆìœ¼ë¯€ë¡œ 

```python
class Enrollment(models.Model) :
	lecture  = models.ForeignKey(Lecture, on_delete =models.CASCADE)
	student  = models.ForeignKey(Student, on_delete =models.CASCADE)
	
	def __str__(self) :
		return f'{self.student.name}ë‹˜ì€ {self.lecture.title} ê³¼ëª©ì„ ìˆ˜ê°•í•˜ì˜€ìŠµë‹ˆë‹¤.'
```



#### ë¯¸ì…˜

1. ë³¸ì¸ì˜ ë°ì´í„°ë¥¼ ë„£ëŠ”ë‹¤.
2. ë³¸ì¸ì´ ë“£ê³  ìžˆëŠ” ê°•ì˜ ëª©ë¡ì˜ ê³¼ëª©ëª…ë§Œ ì¶œë ¥í•˜ë¼

```shell
#[1]
>>> kny = Student.objects.get(name='ê¹€ë‚˜ì˜')

# ë°ì´í„° ì‚½ìž…í•  ë•Œ ì°¸ì¡° ê°ì²´ë¥¼ ë„£ì„ë•ŒëŠ” ì•„ëž˜ì™€ ê°™ì´ ê°ì²´ëª…(stuent)ê³¼ ê°ì²´ë¥¼ ì¨ì¤€ë‹¤.
>>> Enrollment.objects.create(student_id=1, lecture_id=1)
>>> Enrollment.objects.create(student=kny, lecture_id=2)

#[2]
# ì´ë ‡ê²Œ í•œë²ˆì— ì—¬ëŸ¬ê°œ ì¶œë ¥ì´ ê°€ëŠ¥í•˜ë‹¤.
>>> kny.enrollment_set.all()
<QuerySet [<Enrollment: ê¹€ë‚˜ì˜ë‹˜ì€ ë°ì´í„°ë² ì´ìŠ¤ ê³¼ëª©ì„ ìˆ˜ê°•í•˜ì˜€ìŠµë‹ˆë‹¤.>, <Enrollment: ê¹€ë‚˜ì˜ë‹˜ì€ ì•Œê³ ë¦¬ì¦˜ ê³¼ëª©ì„ ìˆ˜ê°•í•˜ì˜€ìŠµë‹ˆë‹¤.>]>

# ê·¸ë ‡ë‹¤ë©´ ê³¼ëª©ëª…ë§Œ ì¶œë ¥í•˜ê¸° ìœ„í•´ì„œëŠ” ì–´ë–»ê²Œ í•´ì•¼í• ê¹Œ?
>>> 
```



## 2. [ë°©ë²•2] ManyToManyField ì‚¬ìš©í•˜ì—¬ M:N ì •ì˜ðŸ¤Ÿ

ì•žì„  3ë²ˆê¹Œì§€ì˜ ëª¨ë¸ë§ì—ì„œëŠ” M:N ê´€ê³„ í…Œì´ë¸”ì„ ë”°ë¡œ  ë§Œë“¤ì—ˆì§€ë§Œ, ManyToManyFieldë¥¼ ì‚¬ìš©í•˜ë©´ ê´€ê³„ í…Œì´ë¸”ì˜ ì •ì˜ ì—†ì´ M:Nì˜ ê´€ê³„ë¥¼ ì •ì˜í•  ìˆ˜ ìžˆë‹¤.

```python
class Client(models.Model) :
	name = models.CharField(max_length=30)
    
	@classmethod
	def dummy(cls, n) :
		for i in range(n) :
			cls.objects.create(name=fake.name())
		
class Resort(models.Model) :
	name = models.CharField(max_length=30)
    # client í…Œì´ë¸”ê³¼ì˜ ë§¤í•‘ì„ ë§Œë“ ë‹¤. 
    # M:Nì˜ ê´€ê³„ëŠ” ì–´ëŠ í•œìª½ì— ì¢…ì†ë˜ì§€ ì•Šìœ¼ë¯€ë¡œ ì´ ë¶€ë¶„ì„ clientí´ëž˜ìŠ¤ì—ì„œ ì„ ì–¸í•´ë„ ë™ì¼í•œ ê¸°ëŠ¥ì„ ìˆ˜í–‰í•œë‹¤.
	clients = models.ManyToManyField(Client)
	
	@classmethod
	def dummy(cls, n) :
		for i in range(n) :
			cls.objects.create(name=fake.company())

```



### 2-1. migrateê°€ ìˆ˜í–‰í•  sqlë¬¸

```shell
$python manage.py sqlmigrate class {migrationíŒŒì¼}
BEGIN;
--
-- Create model Client
--
CREATE TABLE "class_client" ("id" integer NOT NULL PRIMARY KEY AUTOINCREMENT, "name" varchar(30) NOT NULL);
--
-- Create model Resort
--
CREATE TABLE "class_resort" ("id" integer NOT NULL PRIMARY KEY AUTOINCREMENT, "name" varchar(30) NOT NULL);
CREATE TABLE "class_resort_clients" ("id" integer NOT NULL PRIMARY KEY AUTOINCREMENT, "resort_id" integer NOT NULL REFERENCES "class_resort" ("id") DEFERRABLE INITIALLY DEFERRED, "client_id" integer NOT NULL REFERENCES "class_client" ("id") DEFERRABLE INITIALLY DEFERRED);
CREATE UNIQUE INDEX "class_resort_clients_resort_id_client_id_f16f6848_uniq" ON "class_resort_clients" ("resort_id", "client_id");
CREATE INDEX "class_resort_clients_resort_id_55a6d3f0" ON "class_resort_clients" ("resort_id");
CREATE INDEX "class_resort_clients_client_id_e2d1d88b" ON "class_resort_clients" ("client_id");
COMMIT;
```

ìœ„ì˜ ë‚´ìš©ì„ ì‚´í‘œë³´ë©´ CREATE TABLEì„ ì„¸ë²ˆ ìˆ˜í–‰í•œë‹¤. ì¦‰ Djangoì˜ ORMì´ ìžë™ìœ¼ë¡œ M:N ë§¤í•‘ í…Œì´ë¸”ì„ ìƒì„±í•˜ê³  ìžˆìŒì„ í™•ì¸ í•  ìˆ˜ ìžˆë‹¤.



### 2-2. ë°ì´í„° ì‚½ìž… / ì‚­ì œ / ì¡°íšŒðŸ¤Ÿ

```shell
$python managy.py shell_plus
# ë°ì´í„° ì¡°íšŒ
>>> Client.objects.all()
<QuerySet [<Client: ë°•ë™í˜„>, <Client: ìž¥ì•„ë¦„>, '...(remaining elements truncated)...']>
>>> Resort.objects.all()
<QuerySet [<Resort: ìœ í•œíšŒì‚¬ ê¹€>, <Resort: ìœ í•œíšŒì‚¬ ì´>, <Resort: (ìœ ) ì •>, <Resort: ê¹€ì´>, <Resort: ë‚¨ì´>]>

# resortë¥¼ ë°›ì•„ì™€ì„œ í•´ë‹¹ resortë¥¼ ì˜ˆì•½í•œ ê³ ê° ëª©ë¡ì„ ë³´ì—¬ì£¼ìž
>>> resort = Resort.objects.get(pk=2)
>>> resort.clients
<django.db.models.fields.related_descriptors.create_forward_many_to_many_manager.<locals>.ManyRelatedManager object at 0x7fd528a810b8>
# [ì¡°íšŒ]
>>> resort.clients.all()
<QuerySet []>
# [ì‚½ìž…] add()ë¡œ ê°„ë‹¨í•˜ê²Œ ì¶”ê°€ê°€ ê°€ëŠ¥í•˜ë‹¤.
>>> resort.clients.add(Client.objects.first())
>>> resort.clients.all()
<QuerySet [<Client: ë°•ë™í˜„>]>
>>> resort.clients.add(Client.objects.last())
>>> resort.clients.all()
<QuerySet [<Client: ë°•ë™í˜„>, <Client: ì´ì„œì—°>]>
# [ì‚­ì œ] remove()ë¡œ ê°„ë‹¨í•˜ê²Œ ì‚­ì œê°€ ê°€ëŠ¥í•˜ë‹¤.
>>> resort.clients.remove(Client.objects.last())
>>> resort.clients.all()
<QuerySet [<Client: ë°•ë™í˜„>]>
```



### 2-3. ManyToManyFieldì˜ ìžë™ ì¤‘ë³µì œê±°

```shell
$python managy.py shell_plus
>>> resort.clients.all()
<QuerySet [<Client: ë°•ë™í˜„>]>
# ë°•ë™í˜„ì´ ìžˆëŠ” ìƒíƒœì—ì„œ ë°•ë™í˜„ì„ ì‚½ìž…í•˜ëŠ” ê²½ìš° ì¤‘ë³µì„ ìžë™ìœ¼ë¡œ ë°©ì§€í•´ì¤€ë‹¤.
>>> resort.clients.add(Client.objects.first())
>>> resort.clients.all()
<QuerySet [<Client: ë°•ë™í˜„>]

# [ë°©ë²•1]ë¡œ ìœ„ì™€ ê°™ì€ ìž‘ì—…ì„ ìˆ˜í–‰í•˜ë©´, ì¤‘ë³µëœ ê°’ì´ ì €ìž¥ëœë‹¤.
```

ManyToManyFieldëŠ” [ë°©ë²• 1]ê³¼ ë‹¬ë¦¬, ì¤‘ë³µì„ ìžë™ìœ¼ë¡œ ì œê±°í•´ì¤€ë‹¤. ê·¸ëŸ¬ë¯€ë¡œ [ë°©ë²•1] ì²˜ëŸ¼ ì§ì ‘ ì •ì˜í•˜ëŠ” ë°©ì‹ì´ ì•„ë‹Œ, ManyToManyFieldë¥¼ ì‚¬ìš©í•˜ë‹¤ë¡ í•˜ìž.



### 2-4. Clientì—ì„œ Resort ì¡°íšŒ

```shell
$python managy.py shell_plus
>>>client = Client.objects.first()

>>> client.resort_set.all()
<QuerySet [<Resort: ìœ í•œíšŒì‚¬ ì´>]>
```

ì•„ëž˜ì™€ ê°™ì´ ê´€ê³„ë¥¼ ë§¤í•‘í•  ë•Œ related_nameì„ ì„¤ì •í•´ì£¼ë©´ resort_setìœ¼ë¡œ ì ‘ê·¼í•˜ëŠ” ê²ƒì´ ì•„ë‹Œ related_nameìœ¼ë¡œ ì ‘ê·¼ì´ ê°€ëŠ¥í•˜ë‹¤.

```shell
$python managy.py shell_plus
>>> client.resorts.all()
<QuerySet [<Resort: ìœ í•œíšŒì‚¬ ì´>]>
```









